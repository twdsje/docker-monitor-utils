{% if os == 'windows' %}

HostnameItem=system.hostname[host]
HostInterfaceItem=zbx.getIpaddr
Server={{ ZABBIX_AGENT_SERVER }}
ServerActive={{ ZABBIX_AGENT_SERVERACTIVE }}
ControlSocket=\\.\pipe\agent.sock
TLSPSKIdentity={{ AUTOREGISTRATION_TLSPSKIDENTITY }}
TLSConnect=psk
TLSAccept=psk
TLSPSKFile=C:\app\zabbix\psk.key
LogFile=C:\app\zabbix\zabbix_agent2.log
HostMetadata=
HostMetadataItem=system.uname

UserParameter=zbx.getDns,powershell.exe -NonInteractive -NoProfile -Command "(hostname).ToLower()+\".{{ DEFAULT_DOMAIN }}\""
UserParameter=zbx.getIpaddr,powershell.exe -NonInteractive -NoProfile -Command "(Get-NetIPAddress -InterfaceIndex (Get-NetIPInterface -ConnectionState Connected -InterfaceAlias "Ethernet*").ifIndex).IPv4Address | Select -First 1"
UserParameter=zbx.getPublicIpaddr,powershell.exe -NonInteractive -NoProfile -Command "(Invoke-WebRequest -uri "http://api.ipify.org" -UseBasicParsing).Content"
UserParameter=zbx.getZabbixAgentVersion,powershell.exe -NonInteractive -NoProfile -Command "/app/zabbix/zabbix_agent2.exe --version | Select -first 1"

# Examples
# AllowKey=system.run[*]
# DenyKey=system.run[*]
# AllowKey=system.run[get-service]
# AllowKey=system.run[hostname]
# UserParameter=zbx.getDns,powershell.exe -NonInteractive -NoProfile -ExecutionPolicy bypass -File "C:\app\zabbix\scripts\getDNS.ps1"
# HostInterface=myhost.example.com
# HostInterface=10.x.x.x


{% elif os == 'linux' %}

HostnameItem=system.hostname
HostInterfaceItem = {{ hostInterfaceItem }}
Server={{ ZABBIX_AGENT_SERVER }}
ServerActive={{ ZABBIX_AGENT_SERVERACTIVE }}
ControlSocket=/tmp/agent.sock
PidFile=/run/zabbix/zabbix_agent2.pid
LogFile=/var/log/zabbix/zabbix_agent2.log
LogFileSize=0
ListenPort=10050
HostMetadata=
HostMetadataItem=system.uname
Include=/etc/zabbix/zabbix_agent2.d/*.conf

TLSConnect=psk
TLSAccept=psk
TLSPSKIdentity={{ AUTOREGISTRATION_TLSPSKIDENTITY }}
TLSPSKFile=/etc/zabbix/psk.key

UserParameter=zbx.getDns, bash -c "hostname | awk '{print tolower($0)".{{ DEFAULT_DOMAIN }}"}'" 
UserParameter=zbx.getIpaddr, bash -c "ip route get 8.8.8.8 | awk -F\"src \" 'NR==1{split(\$2,a,\" \");print a[1]}'"  # https://stackoverflow.com/questions/21336126/linux-bash-script-to-extract-ip-address
UserParameter=zbx.getPublicIpaddr, bash -c "curl -s https://api.ipify.org"
UserParameter=zbx.getZabbixAgentVersion, bash -c "/usr/sbin/zabbix_agent2 --version | head -n 1"

# Examples
# AllowKey=system.run[*]
# DenyKey=system.run[*]
# AllowKey=system.run[get-service]
# AllowKey=system.run[hostname]
# UserParameter=zbx.getDns,bash "/etc/zabbix/scripts/getDNS.ps1"
# HostInterface=myhost.example.com
# HostInterface=10.x.x.x

{% else %}

Unsupported OS

{% endif %}
